<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Vigimap ‚Äì Tableau de bord admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body { height:100%; margin:0; font-family:Arial,sans-serif; background:#f0f2f5; }
#header {
  position:absolute; top:20px; left:80px; background:white; padding:8px 14px;
  border-radius:10px; display:flex; align-items:center; z-index:1000;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
#header img { height:50px; margin-right:12px; }
#header span { font-weight:bold; font-size:14px; }

#container { display:flex; height:100%; }
#map { flex:2; }
#panel { flex:1; background:white; padding:20px; overflow-y:auto; box-shadow:-3px 0 12px rgba(0,0,0,0.15); }

h2 { margin-top:0; text-align:center; }
label { font-weight:bold; margin-top:12px; display:block; }
input, select, textarea {
  width:100%; padding:8px; margin-top:4px;
  border-radius:6px; border:1px solid #ccc;
}
textarea { resize:vertical; min-height:80px; }

button {
  margin-top:12px; padding:10px; border:none;
  border-radius:6px; font-size:15px; cursor:pointer;
}
#createClientBtn { background:#27ae60; color:white; }
#saveBtn { background:#2c3e50; color:white; }
#deleteBtn { background:#c0392b; color:white; }

.checkbox-group {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-top:4px;
}

#toast {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#2ecc71;
  color:white;
  padding:12px 20px;
  border-radius:8px;
  font-weight:bold;
  opacity:0;
  transition:opacity .3s;
  z-index:3000;
}

/* ===== LOGIN OVERLAY ===== */
#loginOverlay {
  position:absolute;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); display:flex;
  justify-content:center; align-items:center; z-index:5000;
}
#loginBox {
  background:white; padding:30px; border-radius:12px;
  box-shadow:0 4px 16px rgba(0,0,0,0.3);
  width:300px; display:flex; flex-direction:column; gap:12px;
}
#loginBox input { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; }
#loginBox button { padding:10px; border:none; border-radius:6px; background:#2c3e50; color:white; cursor:pointer; font-size:15px; }
</style>
</head>

<body>

<!-- ===== LOGIN ADMIN ===== -->
<div id="loginOverlay">
  <div id="loginBox">
    <h3>Connexion Administrateur</h3>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Mot de passe">
    <button id="loginBtn">Se connecter</button>
  </div>
</div>

<div id="header">
  <img src="https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__9_-removebg-preview-high.png?enable-io=true&width=532">
  <span>Tableau de bord ‚Äì Administration Vigimap</span>
</div>

<div id="container">
  <div id="map"></div>

  <div id="panel">
    <h2>Cr√©er un client</h2>
    <label>UID Firebase Auth</label>
    <input id="clientUid">
    <label>Email</label>
    <input id="clientEmail">
    <label>Nom du contact</label>
    <input id="clientContact">
    <label>Entreprise</label>
    <input id="clientCompany">
    <button id="createClientBtn">‚ûï Cr√©er le client + point initial</button>

    <hr>

    <h2>Modifier un point</h2>
    <label>UID du client</label>
    <input id="pointUserId" disabled>
    <label>Nom du point</label>
    <input id="pointName">
    <label>Lieu</label>
    <input id="pointLocation">

    <label>Type de ph√©nom√®ne</label>
    <select id="phenomenonType">
      <option value="orages">Orages</option>
      <option value="neige">Neige</option>
      <option value="inondations">Inondations</option>
    </select>

    <label>Niveau de vigilance</label>
    <select id="alertLevel">
      <option value="1">Aucun</option>
      <option value="2">Faible</option>
      <option value="3">Mod√©r√©/fort</option>
      <option value="4">Violent</option>
      <option value="5">Extr√™me</option>
    </select>

    <label>Ph√©nom√®nes associ√©s</label>
    <div class="checkbox-group">
      <label><input type="checkbox" data-key="rafales"> Fortes rafales</label>
      <label><input type="checkbox" data-key="petiteGrele"> Petite gr√™le</label>
      <label><input type="checkbox" data-key="grelleMoyenne"> Gr√™le moyenne</label>
      <label><input type="checkbox" data-key="grelleGrosse"> Grosse gr√™le</label>
      <label><input type="checkbox" data-key="fortesPrecip"> Fortes pr√©cipitations</label>
      <label><input type="checkbox" data-key="activiteElec"> Activit√© √©lectrique</label>
      <label><input type="checkbox" data-key="ruissements"> Ruissellements</label>
    </div>

    <label>Description / aide √† la d√©cision</label>
    <textarea id="description"></textarea>

    <button id="saveBtn">üíæ Sauvegarder le point</button>
    <button id="deleteBtn">üóëÔ∏è Supprimer le point</button>
  </div>
</div>

<div id="toast"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp, updateDoc, getDoc, getDocFromServer } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyDqb1u1HSfjmE-lE4ml9NrwGbAKCjf1D5o",
  authDomain:"vigimap-966e9.firebaseapp.com",
  projectId:"vigimap-966e9"
});
const db = getFirestore(app);
const auth = getAuth(app);

function toast(msg,color="#2ecc71"){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.background=color;
  t.style.opacity=1;
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.style.opacity=0,2000);
}

/* ===== LOGIN ADMIN ===== */
const loginOverlay=document.getElementById("loginOverlay");
const loginBtn=document.getElementById("loginBtn");
loginBtn.onclick=async()=>{
  const email=document.getElementById("loginEmail").value.trim();
  const password=document.getElementById("loginPassword").value.trim();
  if(!email || !password) return alert("Remplissez email et mot de passe");

  try{
    const cred=await signInWithEmailAndPassword(auth,email,password);
    const uid=cred.user.uid;
    const adminDoc=await getDoc(doc(db,"admins",uid));
    if(!adminDoc.exists() || adminDoc.data().role!=="admin"){
      auth.signOut();
      alert("Acc√®s refus√©");
      return;
    }
    loginOverlay.style.display="none"; // ‚úÖ cache login
    loadDashboard(); // üîπ lance la carte et fonctions
  }catch(e){
    alert("Erreur login: "+e.message);
  }
};

/* ===== TABLEAU DE BORD ===== */
function loadDashboard(){
  const map=L.map("map").setView([44.35,2.57],9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// üîπ Style pour les contours des d√©partements
const deptStyle = {
  color: "#2c3e50",
  weight: 1,
  fillColor: "#2c3e50",
  fillOpacity: 0.05
};

// üîπ URL du GeoJSON simplifi√© des d√©partements
const deptGeojsonUrl =
  "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson";

// üîπ Charger le GeoJSON et filtrer les d√©partements cibl√©s
fetch(deptGeojsonUrl)
  .then(response => response.json())
  .then(data => {
    // Codes INSEE des d√©partements cibl√©s : Lot(46), Corr√®ze(19), Cantal(15), Loz√®re(48), Aveyron(12), Tarn(81), Tarn-et-Garonne(82)
    const codesVoulu = ["46", "19", "15", "48", "12", "81", "82"];

    const filtered = {
      type: "FeatureCollection",
      features: data.features.filter(
        f => f.properties.code && codesVoulu.includes(f.properties.code)
      )
    };

    // Ajouter les contours filtr√©s √† la carte
    L.geoJSON(filtered, {
      style: deptStyle
    }).addTo(map);

  })
  .catch(err =>
    console.error("Erreur chargement GeoJSON d√©partements:", err)
  );


  /* üîí FIX MAJEUR LEAFLET */
  L.DomEvent.disableClickPropagation(document.getElementById("panel"));
  L.DomEvent.disableScrollPropagation(document.getElementById("panel"));
  setTimeout(()=>map.invalidateSize(),300);

  const icons={};
  [1,2,3,4,5,6].forEach(i=>{
    icons[i]=L.icon({
      iconUrl:`https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__${9+i}_-removebg-preview-high.png`,
      iconSize:[35,35]
    });
  });

  const pointsRef=collection(db,"points");
  const markers={};
  let selected=null;
  let phenomena={};

  function syncCheckboxes(){
    document.querySelectorAll(".checkbox-group input").forEach(cb=>{
      cb.checked=phenomena[cb.dataset.key]||false;
    });
  }

  document.querySelectorAll(".checkbox-group input").forEach(cb=>{
    cb.addEventListener("change",()=>{
      if(!selected) return;
      phenomena[cb.dataset.key]=cb.checked;
    });
  });

  function loadPointData(id,data){
    selected=id;
    pointUserId.value=data.userId;
    pointName.value=data.name;
    pointLocation.value=data.location;
    phenomenonType.value=data.phenomenonType;
    alertLevel.value=data.alertLevel;
    description.value=data.description;
    phenomena={...data.phenomena};
    syncCheckboxes();
  }

  function addMarker(id,d){
    if(markers[id]) markers[id].setIcon(icons[d.alertLevel]);
    else{
      const m=L.marker([d.lat,d.lng],{icon:icons[d.alertLevel]}).addTo(map);
      m.on("click",async()=>{
        const s=await getDoc(doc(db,"points",id));
        loadPointData(id,s.data());
      });
      markers[id]=m;
    }
  }

  onSnapshot(pointsRef,s=>s.docChanges().forEach(c=>{
    if(c.type!=="removed") addMarker(c.doc.id,c.doc.data());
    else if(markers[c.doc.id]){
      map.removeLayer(markers[c.doc.id]);
      delete markers[c.doc.id];
    }
  }));

  createClientBtn.onclick=async()=>{
    if(!clientUid.value) return alert("UID requis");

    await setDoc(doc(db,"users",clientUid.value),{
      email:clientEmail.value,
      role:"client",
      active:true,
      contactName:clientContact.value,
      companyName:clientCompany.value,
      createdAt:serverTimestamp()
    });

    const c=map.getCenter();
    await addDoc(pointsRef,{
      userId:clientUid.value,
      name:"Point initial",
      location:"",
      phenomenonType:"orages",
      alertLevel:1,
      description:"",
      phenomena:{},
      lat:c.lat,
      lng:c.lng,
      updatedAt:serverTimestamp()
    });

    toast("‚ûï Client et point cr√©√©s","#27ae60");
  };

  saveBtn.onclick=async()=>{
    if(!selected) return alert("S√©lectionnez un point");
    await updateDoc(doc(db,"points",selected),{
      name:pointName.value,
      location:pointLocation.value,
      phenomenonType:phenomenonType.value,
      alertLevel:Number(alertLevel.value),
      description:description.value,
      phenomena:{...phenomena},
      updatedAt:serverTimestamp()
    });
    toast("üíæ Point sauvegard√©");
  };

  deleteBtn.onclick=async()=>{
    if(!selected) return alert("S√©lectionnez un point");
    await deleteDoc(doc(db,"points",selected));
    selected=null;
    toast("üóëÔ∏è Point supprim√©","#e74c3c");
  };
}
</script>
</body>
</html>
