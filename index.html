<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Vigimap ‚Äì Tableau de bord admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body { height:100%; margin:0; font-family:Arial,sans-serif; background:#f0f2f5; }
#header { position:absolute; top:20px; left:80px; background:white; padding:8px 14px; border-radius:10px; display:flex; align-items:center; z-index:1000; box-shadow:0 4px 12px rgba(0,0,0,0.2);}
#header img { height:50px; margin-right:12px; }
#header span { font-weight:bold; font-size:14px; }

#container { display:flex; height:100%; }
#map { flex:2; }
#panel { flex:1; background:white; padding:20px; overflow-y:auto; box-shadow:-3px 0 12px rgba(0,0,0,0.15); }

h2 { margin-top:0; text-align:center; }
label { font-weight:bold; margin-top:12px; display:block; }
input, select, textarea { width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc; }
textarea { resize:vertical; min-height:80px; }

button { margin-top:12px; padding:10px; border:none; border-radius:6px; font-size:15px; cursor:pointer; }
#createClientBtn { background:#27ae60; color:white; }
#saveBtn { background:#2c3e50; color:white; }
#deleteBtn { background:#c0392b; color:white; }

.checkbox-group { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px; }

#toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#2ecc71; color:white; padding:12px 20px; border-radius:8px; font-weight:bold; opacity:0; transition:opacity .3s; z-index:3000; }

#loginOverlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:5000; }
#loginBox { background:white; padding:30px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.3); width:300px; display:flex; flex-direction:column; gap:12px; }
#loginBox input { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; }
#loginBox button { padding:10px; border:none; border-radius:6px; background:#2c3e50; color:white; cursor:pointer; font-size:15px; }
</style>
</head>

<body>

<div id="loginOverlay">
  <div id="loginBox">
    <h3>Connexion Administrateur</h3>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Mot de passe">
    <button id="loginBtn">Se connecter</button>
  </div>
</div>

<div id="header">
  <img src="https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__9_-removebg-preview-high.png?enable-io=true&width=532">
  <span>Tableau de bord ‚Äì Administration Vigimap</span>
</div>

<div id="container">
  <div id="map"></div>

  <div id="panel">
    <h2>Cr√©er un client</h2>
    <label>UID Firebase Auth</label>
    <input id="clientUid">
    <label>Email</label>
    <input id="clientEmail">
    <label>Nom du contact</label>
    <input id="clientContact">
    <label>Entreprise</label>
    <input id="clientCompany">
    <button id="createClientBtn">‚ûï Cr√©er le client + point initial</button>

    <hr>

    <h2>Modifier un point</h2>
    <label>UID du client</label>
    <input id="pointUserId" disabled>
    <label>Nom du point</label>
    <input id="pointName">
    <label>Lieu</label>
    <input id="pointLocation">

    <label>Type de ph√©nom√®ne</label>
    <select id="phenomenonType">
      <option value="orages">Orages</option>
      <option value="neige">Neige</option>
      <option value="inondations">Inondations</option>
    </select>

    <label>Niveau de vigilance</label>
    <select id="alertLevel">
      <option value="1">Aucun</option>
      <option value="2">Faible</option>
      <option value="3">Mod√©r√©/fort</option>
      <option value="4">Violent</option>
      <option value="5">Extr√™me</option>
    </select>

    <label>Ph√©nom√®nes associ√©s</label>
    <div class="checkbox-group">
      <label><input type="checkbox" data-key="rafales"> Fortes rafales</label>
      <label><input type="checkbox" data-key="petiteGrele"> Petite gr√™le</label>
      <label><input type="checkbox" data-key="grelleMoyenne"> Gr√™le moyenne</label>
      <label><input type="checkbox" data-key="grelleGrosse"> Grosse gr√™le</label>
      <label><input type="checkbox" data-key="fortesPrecip"> Fortes pr√©cipitations</label>
      <label><input type="checkbox" data-key="activiteElec"> Activit√© √©lectrique</label>
      <label><input type="checkbox" data-key="ruissements"> Ruissellements</label>
    </div>

    <label>Description / aide √† la d√©cision</label>
    <textarea id="description"></textarea>

    <button id="saveBtn">üíæ Sauvegarder le point</button>
    <button id="deleteBtn">üóëÔ∏è Supprimer le point</button>

    <hr>

    <h2>Surveillance active</h2>
    <label>Type</label>
    <select id="surveillanceType">
      <option value="">-- S√©lectionner --</option>
      <option value="grele">Gr√™le</option>
      <option value="vent">Vent</option>
    </select>

  </div>
</div>

<div id="toast"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyDqb1u1HSfjmE-lE4ml9NrwGbAKCjf1D5o",
  authDomain:"vigimap-966e9.firebaseapp.com",
  projectId:"vigimap-966e9"
});
const db = getFirestore(app);
const auth = getAuth(app);

function toast(msg,color="#2ecc71"){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.background=color;
  t.style.opacity=1;
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.style.opacity=0,2000);
}

loginBtn.onclick=async()=>{
  const email=loginEmail.value.trim();
  const password=loginPassword.value.trim();
  if(!email || !password) return alert("Remplissez email et mot de passe");
  const cred=await signInWithEmailAndPassword(auth,email,password);
  loginOverlay.style.display="none";
  loadDashboard();
};

function loadDashboard(){
  const map=L.map("map").setView([44.35,2.57],9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const icons={};
  [1,2,3,4,5,6].forEach(i=>{
    icons[i]=L.icon({
      iconUrl:`https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__${9+i}_-removebg-preview-high.png`,
      iconSize:[35,35]
    });
  });

  const pointsRef=collection(db,"points");
  const markers={};
  let selected=null;
  let phenomena={};

  // ‚ö° GESTION DES CHECKBOX
  document.querySelectorAll('.checkbox-group input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const key = cb.dataset.key;
      phenomena[key] = cb.checked;
    });
  });

  function loadPointData(id,data){
    selected=id;
    pointUserId.value=data.userId;
    pointName.value=data.name;
    pointLocation.value=data.location;
    phenomenonType.value=data.phenomenonType;
    alertLevel.value=data.alertLevel;
    description.value=data.description;
    phenomena={...data.phenomena};

    // ‚ö° R√©initialiser les checkbox
    document.querySelectorAll('.checkbox-group input[type=checkbox]').forEach(cb=>{
      const key = cb.dataset.key;
      cb.checked = !!phenomena[key];
    });
  }

  function addMarker(id,d){
    if(markers[id]) markers[id].setIcon(icons[d.alertLevel]);
    else{
      const m=L.marker([d.lat,d.lng],{icon:icons[d.alertLevel]}).addTo(map);
      m.on("click",async()=>{
        const s=await getDoc(doc(db,"points",id));
        loadPointData(id,s.data());
      });
      markers[id]=m;
    }
  }

  onSnapshot(pointsRef,s=>s.docChanges().forEach(c=>{
    if(c.type!=="removed") addMarker(c.doc.id,c.doc.data());
    else if(markers[c.doc.id]){
      map.removeLayer(markers[c.doc.id]);
      delete markers[c.doc.id];
    }
  }));

  createClientBtn.onclick = async () => {
    if(!clientUid.value) return alert("UID requis");

    await setDoc(doc(db,"users",clientUid.value),{
        email:clientEmail.value, role:"client", active:true,
        contactName:clientContact.value, companyName:clientCompany.value,
        createdAt:serverTimestamp()
    });

    toast("‚úÖ Client cr√©√©, cliquez sur la carte pour placer le point initial","#27ae60");

    function handleMapClick(e){
        addDoc(pointsRef,{
            userId:clientUid.value, name:"Point initial", location:"",
            phenomenonType:"orages", alertLevel:1, description:"",
            phenomena:{}, lat:e.latlng.lat, lng:e.latlng.lng, updatedAt:serverTimestamp()
        }).then(()=>{
            toast("‚ûï Point initial ajout√©","#27ae60");
        }).finally(()=>{ map.off("click", handleMapClick); });
    }

    map.on("click", handleMapClick);
  };

  saveBtn.onclick=async()=>{
    if(!selected) return alert("S√©lectionnez un point");
    await updateDoc(doc(db,"points",selected),{
      name:pointName.value, location:pointLocation.value,
      phenomenonType:phenomenonType.value, alertLevel:Number(alertLevel.value),
      description:description.value, phenomena:{...phenomena},
      updatedAt:serverTimestamp()
    });
    toast("üíæ Point sauvegard√©");
  };

  deleteBtn.onclick=async()=>{
    if(!selected) return alert("S√©lectionnez un point");
    await deleteDoc(doc(db,"points",selected));
    selected=null;
    toast("üóëÔ∏è Point supprim√©","#e74c3c");
  };

  const surveillanceRef = collection(db,"surveillancePoints");
  const surveillanceMarkers = {};

  const surveillanceIcons = {
    grele: L.icon({
      iconUrl:"https://emojigraph.org/media/openmoji/red-triangle-pointed-up_1f53a.png",
      iconSize:[30,30], iconAnchor:[15,30]
    }),
    vent: L.icon({
      iconUrl:"https://images.icon-icons.com/8/PNG/256/weather_wind_flag_storm_travel_1455.png",
      iconSize:[30,30], iconAnchor:[15,30]
    })
  };

  map.on("click", async (e)=>{
    const type = document.getElementById("surveillanceType").value;
    if(!type) return;
    await addDoc(surveillanceRef,{
      type:type,
      lat:e.latlng.lat,
      lng:e.latlng.lng,
      createdAt:serverTimestamp()
    });
    toast("Point de surveillance ajout√©");
  });

  onSnapshot(surveillanceRef,(snap)=>{
    snap.docChanges().forEach(change=>{
      const id=change.doc.id;
      const d=change.doc.data();
      if(change.type==="added"){
        const marker=L.marker([d.lat,d.lng],{icon:surveillanceIcons[d.type]}).addTo(map);
        marker.on("click",async()=>{
          if(confirm("Supprimer ce point de surveillance ?")){
            await deleteDoc(doc(db,"surveillancePoints",id));
          }
        });
        surveillanceMarkers[id]=marker;
      }
      if(change.type==="removed"){
        if(surveillanceMarkers[id]){
          map.removeLayer(surveillanceMarkers[id]);
          delete surveillanceMarkers[id];
        }
      }
    });
  });

}
</script>
</body>
</html>
